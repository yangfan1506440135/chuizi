<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>春纪</title>
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/float-nav.css">
    <link rel="stylesheet" href="css/shoppingcar.css">
    <link rel="stylesheet" href="css/content.css">
</head>

<body>
    <div id="header">
        <div class="top">
            <div class="top-left">客服专线：400-830-4000 </div>
            <h1 class="top-logo"><a href="index.html"></a></h1>
            <div class="top-right  cl">
                <div class="car cl">
                    <a href="shoppingcar.html">
                        <img src="img/images/sprite_06.jpg" alt="">
                        <span class="car-text">我的购物车</span>
                        <span class="car-count">
                            (<b class="car-number">0</b>)
                        </span>
                    </a>
                </div>
                <div class="top-right-login">
                    <span class="sign">
                        <a href="login.html" class="sign_in">登陆</a>
                        <span class="comma">/</span>
                        <a href="register.html" class="sign_up">注册</a>
                    </span>
                    <span class="userinfo">
                        <span class="username">yangfan</span><button id="exist">退出</button>
                    </span>
                </div>
            </div>
        </div>
        <div class="under">
            <div class="menu cl">
                <div class="menu-mid">
                    <div class="item item1">
                        <a href="index.html">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">首页</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">首页</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item2">
                        <a href="goodslist.html">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">官方商城</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">官方商城</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item3">
                        <a href="">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">食材养肤</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">食材养肤</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item4">
                        <a href="">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">产品分类</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">产品分类</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item5">
                        <a href="">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">春纪名片</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">春纪名片</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item6">
                        <a href="">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">养肤专栏</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">养肤专栏</div>
                            </div>
                        </a>
                    </div>
                    <div class="item item7">
                        <a href="">
                            <div class="hover-before">
                                <div class="t-item"></div>
                                <div class="b-item">会员中心</div>
                            </div>
                            <div class="hover-after">
                                <div class="t-item"></div>
                                <div class="b-item">会员中心</div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="menu-right">
                    <div class="menu-right-t-item"></div>
                    <div class="menu-right-content">
                        <input type="text" id="searchcontent">
                        <button id="search">搜索</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="shoppingcar">
        <div class="w">
            <div class="shopping_nav">
                <div class="Navigation">
                    <span>
                        <a href="goodslist.html">商城首页</a>
                    </span>
                    <span class="comma">></span>
                    <span class="now">购物车</span>
                </div>
            </div>
            <div class="main">
                <div class="cart-title">
                    <span id="cart-ico"></span>
                </div>
                <div class="cart-steps cart-steps1"></div>
                <div class="cart-content">
                    <div class="cart_title">已选择的商品</div>
                    <div id="table">
                        <ul id="th">
                            <li> <input type="checkbox" class="checkAll">全选</li>
                            <li>图片</li>
                            <li>名称</li>
                            <li>价格</li>
                            <li>数量</li>
                            <li>小计</li>
                            <li>操作</li>
                        </ul>
                        <div id="tbody" class="cl">
                            <!-- <ul class="tr cl">
                                <li>
                                    <input type="checkbox" class="check-one">
                                </li>
                                <li>
                                    <img src="img/xp11.jpg" alt="">
                                </li>
                                <li>商品名称</li>
                                <li>100.00</li>
                                <li>
                                    <span class="reduce">-</span>
                                    <input class="count" type="text" value="1">
                                    <span class="add">+</span>
                                </li>
                                <li class="itme_price">￥100</li>
                                <li>删除</li>
                            </ul> -->
                        </div>
                        <div id="tfoot" class="cl">
                            <button id="deleteall" class="deleteall"></button> <button id="pay"></button>
                            <div class="total">合计：￥<span id="priceTotal">0.00</span></div>
                            <div id="selected">已选商品<span id="selectedTotal">0</span>件
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="main1">
        <div class="web-foot">
            <div class="web-foot-top cl">
                <div class="foot-item1">
                    <div class="foot-item1-title">明星单品</div>
                    <ul>
                        <li>发光小奶瓶</li>
                        <li>蓝光水</li>
                        <li>牛扳安瓶</li>
                        <li>皙白霜</li>
                        <li>水凝乳</li>
                    </ul>
                </div>
                <div class="foot-item1">
                    <div class="foot-item1-title">养肤专栏</div>
                    <ul>
                        <li>发光小奶瓶</li>
                        <li>蓝光水</li>
                        <li>牛扳安瓶</li>
                        <li>皙白霜</li>
                        <li>水凝乳</li>
                    </ul>
                </div>
                <div class="foot-item1">
                    <div class="foot-item1-title">养肤系列</div>
                    <ul>
                        <li>发光小奶瓶</li>
                        <li>蓝光水</li>
                        <li>牛扳安瓶</li>
                        <li>皙白霜</li>
                        <li>水凝乳</li>
                    </ul>
                </div>
                <div class="foot-item1">
                    <div class="foot-item1-title">春纪名片</div>
                    <ul>
                        <li>发光小奶瓶</li>
                        <li>蓝光水</li>
                        <li>牛扳安瓶</li>
                        <li>皙白霜</li>
                        <li>水凝乳</li>
                    </ul>
                </div>
                <div class="foot-item1">
                    <div class="foot-item1-title">找到我们</div>
                    <ul>
                        <li>附近门店</li>
                        <li>授权电商</li>
                        <li>官方微博</li>
                        <li>官方微信</li>
                        <li>商城微信</li>
                    </ul>
                </div>
            </div>
            <div class="web-foot-bottom"> 广东丸美生物技术股份有限公司 粤ICP备12040230号 COPYRIGHT@2014 MMARUBI,ALLRIGHTRESERVED
            </div>
        </div>
    </div>

    <div class="float-nav" id="float_nav">
        <div id="float_nav_wrap">
            <div class="column-top">
                <div class="column column1">
                    <a class="gouwuche">
                        <div class="c-ico"></div>
                        <div class="c-text">购物车</div>
                        <div class="c-num"><b class="op-cart-number">0</b></div>
                    </a>
                </div>
                <div class="column column2">
                    <a target="_blank" href="">
                        <div class="c-ico"></div>
                        <div class="c-text">个人中心</div>
                    </a>
                </div>
                <div class="column column3">
                    <a href="javascript:;" target="_self" onclick="OpenChatUrl();">
                        <div class="c-ico"></div>
                        <div class="c-text">在线客服</div>
                    </a>
                </div>
                <div class="column column3">
                    <a href="javascript:;" target="_self" onclick="OpenChat();">
                        <div class="c-ico"></div>
                        <div class="c-text">商品咨询</div>
                    </a>
                </div>
                <div class="column column4">
                    <div class="c-ico"></div>
                    <div class="c-text">官方电话</div>
                    <div class="c-text">400-830</div>
                    <div class="c-text">-4000</div>
                </div>
                <div class="column column5">
                    <div class="c-scan"></div>
                    <div class="c-text">扫码加入</div>
                    <div class="c-text">春纪官方</div>
                    <div class="c-text">微信商城</div>
                </div>
            </div>
            <div class="column column6"><a class="gotop" href="" id="gotop" target="_self"
                    style="visibility: hidden;">回到顶部</a></div>
        </div>
    </div>
</body>
<script src="js/jquery-1.11.3.js"></script>
<script src="js/cookie.js"></script>
<script>
    var loginId = getCookie("loginId");
    if (loginId) {
        var loginName = getCookie("loginName");
        $(".username").html(loginName);
        $(".sign").hide();
        $(".userinfo").show();
        $.ajax({
            type:"get",
            url:"php/showshoppingnumbyuserid.php",
            data:{
                userid:loginId
            },
            dataType:"json",
            success:function(obj){
                var countnum=obj.num;
                $(".op-cart-number").html(countnum);
                $(".car-number").html(countnum);
            }
    })
    $(".op-cart-number").click(function(){
        window.location.href="shoppingcar.html"
    })
    } else {

    }
    $("#exist").click(function () {
        existLogin();
        gotoLogin();
    })
    $(".sign_in").click(function () {
        gotoLogin()
    })
    $(".sign_up").click(function () {
        gotoRegister()
    })
    function existLogin() {
        setCookie("loginId", "", -1);
        setCookie("loginName", "", -1);
        window.location.href = "login.html";
    }
    function gotoLogin() {
        setCookie("backUrl", window.location.href);
        window.location.href = "login.html";
    }
    function gotoRegister() {
        setCookie("backUrl", window.location.href);
        window.location.href = "register.html";
    }
    if (loginId) {
        $.ajax({
            type: "get",
            url: "php/shoppingcar.php",
            data: { userid: loginId },
            dataType: "json",
            success: function (list) {
                var html = "";
                list.forEach(function (item) {
                    var { id, goodsid, goodsname, goodsnum, goodsprice, goodsimg } = item;
                    html += `<ul class="tr cl">
                                <li>
                                    <input type="checkbox" class="check-one" data-id=${id}>
                                </li>
                                <li>
                                    <img src="img/${goodsimg}.jpg" alt="">
                                </li>
                                <li><a href="goodsdetail.html?id=${goodsid}">${goodsname}</a></li>
                                <li class="price-goods">${(goodsprice * 1).toFixed(2)}</li>
                                <li>
                                    <span class="reduce" data-price="${goodsprice}" data-id=${id} >${goodsnum > 1 ? "-" : "&nbsp"}</span>
                                    <input class="count" type="text" value="${goodsnum}">
                                    <span class="add" data-price="${goodsprice}" data-id=${id}>+</span>
                                </li>
                                <li id="subTotal">${(goodsprice * goodsnum).toFixed(2)}</li>
                                <li class="del" data-id=${id}>删除</li>
                            </ul>`
                })
                $("#tbody").html(html);
                $(".checkAll").click(function () {
                    var flag = $(this).prop("checked");
                    $(".check-one").prop("checked", flag);
                    getTotal();
                })
                $(".check-one").click(function () {
                    var checkNum = $(".check-one:checked").length;
                 
                    if (checkNum == $(".check-one").length) {
                        $(".checkAll").prop("checked", true);
                    } else {
                        $(".checkAll").prop("checked", false);
                    };
                    getTotal();
                })
                $("#pay").click(function () {
                    if ($(".check-one:checked").length == 0) {
                        alert("请选择其中一个商品")
                    } else {
                        var price=$("#priceTotal").html();
                        setCookie("price", price);
                        window.location.href = "settlement.html"
                    }

                })
            }
        })
    } else {
        gotoLogin();
    }
    function gotoLogin() {
        setCookie("backUrl", window.location.href, 7);
        window.location.href = "login.html";
    }
    document.onclick = function (e) {
        var evt = window.event || e;
        var target = evt.target;
        switch (target.className) {
            case "add":
            getTotal()
                var countInput = target.previousElementSibling || previousSibling;
                var reduceSpan = countInput.previousElementSibling || previousSibling;
                countInput.value = countInput.value * 1 + 1;
                reduceSpan.innerHTML = "-";
                var price = target.getAttribute("data-price");
                var subTotal = price * countInput.value;
                var subTotalLi = target.parentNode.nextElementSibling;
                subTotalLi.innerHTML = subTotal.toFixed(2);
                var id = target.getAttribute("data-id");
                var goodsnum = countInput.value;
                $.ajax({
                    type: "get",
                    url: "php/add.php",
                    data: {
                        goodsnum: goodsnum,
                        id: id
                    },
                    dataType: "json",
                    success: function (obj) {
                        if (obj["code"] == 1) {
                        } else {
                            alert(obj["msg"]);
                        }
                    }
                })
                break;
            case "reduce":
            getTotal()
                var countInput = target.nextElementSibling || nextSibling;
                if (countInput.value >= 2) {
                    countInput.value -= 1;
                    var price = target.getAttribute("data-price");
                    var subTotal = price * countInput.value;
                    var subTotalLi = target.parentNode.nextElementSibling;
                    subTotalLi.innerHTML = subTotal.toFixed(2);
                    var id = target.getAttribute("data-id");
                    var goodsnum = countInput.value;
                    $.ajax({
                        type: "get",
                        url: "php/add.php",
                        data: {
                            goodsnum: goodsnum,
                            id: id
                        },
                        dataType: "json",
                        success: function (obj) {
                            if (obj["code"] == 1) {
                            } else {
                                alert(obj["msg"]);
                            }
                        }
                    })
                }
                if (countInput.value == 1) {
                    target.innerHTML = "&nbsp;"
                };

                break;
            case "deleteall":
                var checkOneList = document.querySelectorAll(".check-one");
                var list = [];
                for (let i = 0; i < checkOneList.length; i++) {
                    if (checkOneList[i].checked) {
                        var id = checkOneList[i].getAttribute("data-id");
                        list.push(id);
                        checkOneList[i].parentNode.parentNode.remove();
                    }
                }
                var ids = list.join(",");
                $.ajax({
                    type: "get",
                    url: "php/deleteshoppingcar.php",
                    data: {
                        id: ids
                    },
                    dataType: "json",
                    success: function (obj) {
                        if (obj["code"] == 1) {
                        } else {
                            alert(obj["msg"]);
                        }
                    }
                })
                break;
            case "del":
                    var id = $(".del").attr("data-id");
                     $(".del").parent().remove();
                $.ajax({
                        type: "get",
                        url: "php/deleteshoppingcar.php",
                        data: {
                            id: id
                        },
                        dataType: "json",
                        success: function (obj) {
                            if (obj["code"] == 1) {
                            } else {
                                alert(obj["msg"]);
                            }
                        }
                    })
        }
    }

    function getTotal() {
        var totalNum = 0;
        var totalPrice = 0;
        $(".check-one").each(function(){
            var flag = $(this).prop("checked");
            if(flag){
            var price = $(this).parent().parent().children("#subTotal").html()*1;
            var num = $(this).parent().parent().children().children(".count").val()*1;
            totalNum += num;
            totalPrice += price;
            }
        }) 
        $("#priceTotal").html((totalPrice).toFixed(2));
        $("#selectedTotal").html(totalNum);
    }


</script>

</html>